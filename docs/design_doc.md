# ML System Design Doc - Targeting Solution for Telegram MVP v1.1

## 1. Цели и предпосылки 

### 1.1. Зачем идем в разработку продукта?  

- **Бизнес-цель**: Создание ML-решения для автоматизированного подбора Telegram-каналов для размещения рекламы, минимизируя зависимость от таргетологов.  
- **Почему станет лучше**:  
  - Рекламодатели смогут быстро находить наиболее релевантные каналы.  
  - Прогнозирование эффективности рекламы без привлечения таргетологов.  
  - Уменьшение времени и ресурсов на выбор площадок.  
- **Что будем считать успехом итерации**:  
  - Минимум 2 из 20 рекламодателей (из кастдев-группы) готовы запустить рекламу в предложенном канале.

### 1.2. Бизнес-требования и ограничения  

- **Бизнес-требования**:  
  1. Учитывать тематику поста и ограничения, указанные автором, при подборе канала.  
  2. Предоставлять прогноз по количеству просмотров рекламы в предложенных каналах.  

- **Что ожидаем от итерации**:  
  1. Создание базовой модели ранжирования для подбора каналов для размещения постов.  
  2. Тестирование результатов модели на пользователях из группы, участвующей в кастдеве.  

- **Бизнес-процесс пилота**:  
  1. Рекламодатель предоставляет рекламное объявление, которое он хочет разместить.  
  2. Мы возвращаем топ-10 наиболее подходящих каналов для размещения рекламы.  

- **Критерий успеха пилота**:  
  1. Минимум 10% тестовых пользователей соглашаются разместить рекламу в предложенном канале.

### 1.3. Что входит в скоуп проекта/итерации, что не входит   

- **Входит**:  
  1. Сбор данных для обучения и инференса модели через Telegram API.  
  2. Разработка базовой ранжирующей модели.  
  3. Построение API для инференса модели.  

- **Не входит**:  
  1. Разработка интерфейса для запуска на полном объеме клиентов.  
  2. Поддержка мультиплатформенности (выход за рамки Telegram).  

### 1.4. Предпосылки решения  

- Основные данные будут получены через Telegram API, включая метаинформацию о каналах и постах.  
- Горизонт прогноза: ориентировочно 2 дня (уточняется).  
- Будем учитывать тематику поста, авторские ограничения и текущую активность аудитории каналов.  

## 2. Методология  

### 2.1. Постановка задачи  

- Построение ранжирующей модели для рекомендаций Telegram-каналов, подходящих для размещения рекламы.  

### 2.2. Блок-схема решения  

![Описание картинки](./solution_schema.png)
  

### 2.3. Этапы решения задачи  

### Этап 1. Подготовка данных

1. **Описание данных/сущностей**:
   - Данные включают информацию о Telegram-каналах, постах и метриках постов:
     - **Каналы**: информация о названии, участниках, описании и закрепленных сообщениях.
     - **Посты**: текст, ссылки, гео-информация, статистика реакций и просмотров, а также флаги, указывающие на тип содержимого (например, документ, фото, видео).
     - **Метрики**: число просмотров, репостов, комментариев, стандартных и платных реакций.
   - Основной источник данных — парсинг Telegram-каналов. Список каналов расширяется через функционал "похожие каналы".
   - Объем данных достаточен, проблем с качеством разметки нет.

2. **Процесс генерации данных**:
   - Источник данных: Telegram API.
   - Формат: JSON или таблицы базы данных.
   - Регулярность: данные собираются регулярно, процесс парсинга обновляет базу с новыми постами и каналами.

3. **Проблемы с данными**:
   - Трудности с выделением рекламных постов, так как они часто маскируются. Выделение осуществляется с помощью ключевых слов и маркеров рекламы. Уже сформирована базовая разметка.

4. **Конфиденциальность данных**:
   - Данные публичные, обработки конфиденциальной информации не требуется.

5. **Необходимый результат этапа**:
   - Полностью собранный и структурированный датасет, готовый для использования в моделировании.
   - Выделенный поднабор данных с рекламными постами.

---

### Этап 2. Подготовка прогнозных моделей

1. **ML-метрики и функции потерь**:
   - Основная задача: предсказание популярности рекламных постов.
   - Метрики:
     - **MAE/RMSE**: для оценки точности регрессионных предсказаний.
     - **R²**: для оценки объясненной дисперсии.
     - **Precision@k**: для проверки предсказаний на топовых постах.
   - Функция потерь: MSE или Huber loss, учитывая наличие выбросов в статистиках постов.

2. **Схема ML-валидации**:
   - Разделение по времени для учета изменения трендов. (time cutoff)
   - Разделение по каналам для оценки обобщающей способности модели. (channel cutoff)

3. **Бейзлайн и моделирование**:
   - Бейзлайн: предсказание статистик поста средними статистиками по последним k постам.
   - Решение против бейзлайна: градиентный бустинг на фичах постов и каналов (просмотры, реакции, динамика участников).
   - Предобработка:
     - Логарифмическая трансформация таргета.
     - Нормализация числовых фичей.
     - Генерация новых фичей, отражающих динамику и взаимодействие метрик.

4. **Стратегии развития**:
   - Оптимизация гиперпараметров с использованием Optuna.
   - Расширение набора фичей (эмбеддинги текстов постов, каналов).

5. **Анализ и интерпретация**:
   - Использование SHAP для нахождение наиболее значимых фичей.
   - Подготовка отчета и ablation study о том - какие признаки (то есть характеристики поста, канала, их взаимодействие) наиболее значимы для улучшения статистик рекламного поста.

6. **Риски и их снижение**:
   - **Риск:** Плохая предсказательная способность модели:
     - **Мера по снижению:** расчет новых признаков 
   - **Риск:** Ошибки при разметке рекламных постов:
     - **Мера по снижению:** Построение вспомогательной модели для классификации рекламы, использование краудсорсинга.

7. **Необходимый результат этапа**:
   - Модель, предсказывающая статистики рекламных постов с приемлемой точностью.
   - Выделенные важные фичи для интерпретации.

---
### Дополнительно:
- Этапы 3 и 4 можно дополнить, сосредоточив внимание на:
  - Дальнейшей интеграции с бизнес-метриками (оценка ROI от рекламы).
  - Сборе и обработке фидбэка заказчика для улучшения модели.

#### Этап 3: Построение API  
- Создание REST API для инференса модели: входной запрос — текст объявления, выход — топ-10 каналов.  
- Тестирование функционала API на ограниченной выборке данных.  

#### Этап 4: Тестирование пилота  
- Тестирование на кастдев-группе из 20 рекламодателей.  
- Оценка качества рекомендаций по бизнес-метрикам: минимум 10% участников готовы запустить рекламу.

## 3. Подготовка пилота  

### 3.1. Способ оценки пилота  

- Запуск пилотной модели на ограниченной кастдев-группе.  
- Сбор обратной связи от рекламодателей, включая их готовность запустить рекламу в предложенных каналах.  

### 3.2. Критерий успеха пилота  

- Успешным пилот считается, если хотя бы 10% тестовых пользователей готовы разместить рекламу в канале.  

### 3.3. Подготовка пилота  

- Прогнозируемая вычислительная сложность: оценить ресурсы для API-инференса модели на этапе тестирования.  

## 4. Внедрение (для production системы)  

### 4.1. Архитектура решения  

- Основные компоненты:  
  1. Сбор данных (Telegram API).  
  2. Инференс модели (сервер с REST API).  
  3. Обратная связь от пользователей (логирование и оценка).  

### 4.2. Риски  

- Качество данных из Telegram API может быть недостаточным.  
- Модель может предлагать нерелевантные каналы из-за ограниченности данных.  
- Технический долг: не оптимизированный интерфейс или API.  



### Этап 1. Подготовка данных

1. **Описание данных/сущностей**:
   - Данные включают информацию о Telegram-каналах, постах и метриках постов:
     - **Каналы**: информация о названии, участниках, описании и закрепленных сообщениях.
     - **Посты**: текст, ссылки, гео-информация, статистика реакций и просмотров, а также флаги, указывающие на тип содержимого (например, документ, фото, видео).
     - **Метрики**: число просмотров, репостов, комментариев, стандартных и платных реакций.
   - Основной источник данных — парсинг Telegram-каналов. Список каналов расширяется через функционал "похожие каналы".
   - Объем данных достаточен, проблем с качеством разметки нет.

2. **Процесс генерации данных**:
   - Источник данных: Telegram API.
   - Формат: JSON или таблицы базы данных.
   - Регулярность: данные собираются регулярно, процесс парсинга обновляет базу с новыми постами и каналами.

3. **Проблемы с данными**:
   - Трудности с выделением рекламных постов, так как они часто маскируются. Выделение осуществляется с помощью ключевых слов и маркеров рекламы. Уже сформирована базовая разметка.

4. **Конфиденциальность данных**:
   - Данные публичные, обработки конфиденциальной информации не требуется.

5. **Необходимый результат этапа**:
   - Полностью собранный и структурированный датасет, готовый для использования в моделировании.
   - Выделенный поднабор данных с рекламными постами.

---

### Этап 2. Подготовка прогнозных моделей

1. **ML-метрики и функции потерь**:
   - Основная задача: предсказание популярности рекламных постов.
   - Метрики:
     - **MAE/RMSE**: для оценки точности регрессионных предсказаний.
     - **R²**: для оценки объясненной дисперсии.
     - **Precision@k**: для проверки предсказаний на топовых постах.
   - Функция потерь: MSE или Huber loss, учитывая наличие выбросов в статистиках постов.

2. **Схема ML-валидации**:
   - Разделение по времени для учета изменения трендов.
   - Разделение по каналам для оценки обобщающей способности модели.

3. **Бейзлайн и моделирование**:
   - Бейзлайн: градиентный бустинг на фичах постов и каналов (просмотры, реакции, динамика участников).
   - Предобработка:
     - Логарифмическая трансформация таргета.
     - Нормализация числовых фичей.
     - Генерация новых фичей, отражающих динамику и взаимодействие метрик.

4. **Стратегии развития**:
   - Оптимизация гиперпараметров с использованием Optuna.
   - Расширение набора фичей (анализ текстов, временные ряды).
   - Учет бизнес-правил в моделировании (например, весовые коэффициенты для определенных категорий постов).

5. **Анализ и интерпретация**:
   - Использование SHAP для анализа значимости фичей.
   - Кластеризация каналов по статистикам и динамике для выделения групп с разной реакцией на рекламу.

6. **Риски и их снижение**:
   - Плохая предсказательная способность модели:
     - Использовать регуляризацию.
     - Проверять гипотезы на дополнительных датасетах.
   - Ошибки при разметке рекламных постов:
     - Построение вспомогательной модели для классификации рекламы.

7. **Необходимый результат этапа**:
   - Модель, предсказывающая популярность рекламных постов с приемлемой точностью.
   - Выделенные важные фичи и группы каналов для интерпретации.

---

### Дополнительно:
- Этапы 3 и 4 можно дополнить, сосредоточив внимание на:
  - Дальнейшей интеграции с бизнес-метриками (оценка ROI от рекламы).
  - Сборе и обработке фидбэка заказчика для улучшения модели.